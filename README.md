# ChatGPT TTS


### 1. 개요

- ChatGPT <https://chat.openai.com> 에 접속하면 특정 텍스트를 자동으로 프롬프트에 입력 후 그에 대한 답변을 일단 얻어두는 크롬 확장 프로그램. 

- ChatGPT에 프롬프트를 입력했을 때 답변이 생성되면 이를 구글 TTS API에 전송해 얻은 음성파일을 재생시키는 크롬 확장 프로그램. 문단을 클릭하거나 텍스트 블록 설정한 후에 그 부분만 TTS를 재생시킬 수도 있다.

- 텍스트 블록 설정한 후 그 텍스트에 관한 프롬프트(블록 설정된 부분의 의미를 묻는 프롬프트 등)를 텍스트창에 자동으로 입력해주는 크롬 확장 프로그램.



### 2. 제작 동기

- ChatGPT를 사용할 때, '내가 적은 프롬프트가 문법적으로 옳은지 ChatGPT가 먼저 자동으로 교정해준 후 그 다음에 ChatGPT가 내 프롬프트에 대해 답변' 기능을 추가하고 싶어서 만들어 보았다.

- 이후 ChatGPT와 대화 과정에서 생각보다 구글 TTS API 사용이 매우 쉽다는 사실을 파악하고 이를 이용한 TTS 기능을 하나씩 추가하면서 점차 프로젝트 규모가 커졌다.


### 3. 구현 로직

```

1. 문단 클릭 시 일어나야 하는 일
1) 이미 다 로드됨
- tts 얻어와서 플레이큐에 그거 달랑 하나 넣기
- tts 얻어왔으니까 이제 okay to play를 트루로 세팅하고 플레이큐에서 그거 꺼내 재생
- 재생 중 클릭 이벤트 발생 시 일시정지 
- 일시정지 상태에서 다른 부분 클릭 시 플레이큐 날리기


2) 현재 로드 중
- 현재까지 얻어온 녀석들을 문장 단위로 쪼갬
- 완성된 문장 중 새로 들어온 녀석들을 tts에 보내서 결과를 플레이큐에 전달. 
- okay to play를 트루로 세팅하고 플레이큐에 들어온 문장들을 하나씩 재생.
- 재생 중 클릭 이벤트 발생 시 일시정지 
- 일시정지 상태에서 다른 부분 클릭 시 플레이큐 날리기

** 이거 구현이 빡센 게, 두 개의 코드 플로우가 동시에 돌아간다는 점. 
(1) setTimeout으로 계속 리프레시 하면서 e.target에 올라오는 문장들에 대한 tts를 얻어오는 코드 플로우
- 문단 클릭 직후 실행되며 실행된 후에 다시 계속 주기적으로 재귀호출 해야 함.
- 문장들 끝까지 다 로드 됐다면 재귀호출 중단해야 함.

(2) this.audio의 "ended" 이벤트 리스너로 계속 들으면서 끊기면 다시 이어가는 플로우
- 문단 클릭 이후 실행되며 끊길 때마다 계속 큐 돌리면서 재생시켜야 함.


2. 텍스트 셀렉션
1) 셀렉션 시 일어나야 하는 일
- 마우스 커서 근처에 플레이 박스 띄우기

2) 재생 시 일어나야 하는 일
- 셀렉션 된 내용에 대한 tts를 얻어와서 플레이큐에 그거 달랑 하나 넣기
- tts 얻어왔으니까 이제 okay to play를 트루로 세팅하고 플레이큐에서 그거 꺼내 재생
- 재생 중 클릭 이벤트 발생 시 일시정지 
- 일시정지 상태에서 다른 부분 클릭 시 플레이큐 날리기



3. DOM에서 main 태그 안 내용에 텍스트 노드의 mutation이 일어났을 때 일어나야 하는 일
```

1. 문단 클릭 시 일어나야 하는 일
1) 이미 다 로드됨
- tts 얻어와서 플레이큐에 그거 달랑 하나 넣기
- tts 얻어왔으니까 이제 okay to play를 트루로 세팅하고 플레이큐에서 그거 꺼내 재생
- 재생 중 클릭 이벤트 발생 시 일시정지 
- 일시정지 상태에서 다른 부분 클릭 시 플레이큐 날리기


2) 현재 로드 중
- 현재까지 얻어온 녀석들을 문장 단위로 쪼갬
- 완성된 문장 중 새로 들어온 녀석들을 tts에 보내서 결과를 플레이큐에 전달. 
- okay to play를 트루로 세팅하고 플레이큐에 들어온 문장들을 하나씩 재생.
- 재생 중 클릭 이벤트 발생 시 일시정지 
- 일시정지 상태에서 다른 부분 클릭 시 플레이큐 날리기

** 이거 구현이 빡센 게, 두 개의 코드 플로우가 동시에 돌아간다는 점. 
(1) setTimeout으로 계속 리프레시 하면서 e.target에 올라오는 문장들에 대한 tts를 얻어오는 코드 플로우
- 문단 클릭 직후 실행되며 실행된 후에 다시 계속 주기적으로 재귀호출 해야 함.
- 문장들 끝까지 다 로드 됐다면 재귀호출 중단해야 함.

(2) this.audio의 "ended" 이벤트 리스너로 계속 들으면서 끊기면 다시 이어가는 플로우
- 문단 클릭 이후 실행되며 끊길 때마다 계속 큐 돌리면서 재생시켜야 함.


2. 텍스트 셀렉션
1) 셀렉션 시 일어나야 하는 일
- 마우스 커서 근처에 플레이 박스 띄우기

2) 재생 시 일어나야 하는 일
- 셀렉션 된 내용에 대한 tts를 얻어와서 플레이큐에 그거 달랑 하나 넣기
- tts 얻어왔으니까 이제 okay to play를 트루로 세팅하고 플레이큐에서 그거 꺼내 재생
- 재생 중 클릭 이벤트 발생 시 일시정지 
- 일시정지 상태에서 다른 부분 클릭 시 플레이큐 날리기



3. DOM에서 main 태그 안 내용에 텍스트 노드의 mutation이 일어났을 때 일어나야 하는 일
```




### 4. 제작 과정에서 느낀 점

- 처음에는 `MutationObserver`를 통해 DOM에 변화가 발생하면 프롬프트가 자동 입력되도록 구현했으나, 기능을 추가하는 과정에서 `setInterval` 함수를 반드시 써야 하는 프로그램이 돼서 결국 이로써 주기적으로 DOM의 상태를 체크하는 식으로 코드를 변경했다.

- 가장 단순한 기능만 구현하면 코드가 길어질 이유가 전혀 없는 프로그램이지만, 기능이 추가될수록 각 기능을 수행하는 과정에서 각 기능끼리 서로 충돌하는 부분이 굉장히 많아졌고, 중첩적으로 실행되면 안되는 것 같은 부분에 대한 충돌을 해결하기 위해 여러 flag를 통해 lock을 거는 등의 기능을 구현하느라 코드가 다소 장황하고 복잡해졌다. 실제로 이런 식으로 각 기능 간 실행 흐름이 충돌이 발생하는 프로그램을 처음 구현해봐서 제대로 된 로직을 꼼꼼히 신경써서 만들었다고 할 수 있는지는 자신이 없다. 시간이 좀 더 지난 후에 조금씩 뜯어보고 리팩토링 해보며 가독성을 높이고 비효율적인 부분을 걷어내야 할 것 같다.

- 굉장히 단순한 프로그램이라고 생각하고 구현하기 시작했다가 점차 욕심이 생기면서 단계적으로 여러 기능이 추가됐는데, 깊게 생각하지 않고 구현을 시작하다 보니 처음에는 '이런 기능을 구현하려면 이런 코드를 써야 한다'라고 확신을 갖고 쓴 코드더라도 조금 지나고 나니 '도대체 이 코드를 왜 쓴 거지?' 하고 의아해지는 상황이 너무 많이 나타났다. 또 수백 줄을 작성하면서 코드 윗부분과 아랫부분을 동시에 보면서 수정을 해야 하는 상황이 너무 많이 나타났고, 그 과정에서 Vim 등 여러 생산성을 향상시킬 필요성을 매우 크게 느끼게 됐다.

- 특히 이번 프로젝트에서 가장 깊게 고민한 부분은, '물론 처음에 꽤 상세한 수준의 수도코드까지 작성할 정도로 계획을 꼼꼼히 세우고 코딩에 들어가면 당연히 좋겠지만, 그런 바람이 현실적인가?'라는 부분이었다. 개발경험이 부족한데다 이 프로젝트에 대해서도 큰 욕심 전혀 없이 딱 한치 앞만 보고(;;) 손을 대기 시작한 것이기 때문에, 개발 시작 직후에 '상세한 수준의 계획'을 세울 능력은 내게 전혀 없었다. '그렇다면 그 정도 경험과 실력을 갖고 세우는 계획이 과연 현실적이고 유효할까?'라는 생각이 들었고, 최소한 이 프로젝트에 한해서는 '그닥 현실적인 바람은 아니다'라는 생각이 들었다. '계획을 꼼꼼히 세우기 전에 일단 개발을 시작한다'라는 건 어떤 프로젝트에 한해서는 다른 선택지가 없는 유일한 대안일 수도 있겠다는 생각이 들었다. 지금이야 현재 완성돼있는 400여줄의 코드를 내가 다 작성한 이후이니 이 400여줄의 코드에 관해서라면 지금의 나는 물론 어느 정도 '전문가' 위치에 있지만, 개발 초기의 나는 아무 것도 모르는 사람이었을 뿐이다. 그런 사람이 세우는 계획이 현실적이고 유효하리라 생각하긴 어렵다. 

  - 비슷한 프로젝트를 수차례 해서 경험이 쌓인 뒤라면 계획을 세우고 개발에 들어가는 게 유효하고 현실적인 판단이 될까?
  
  - '잘 모르는 사람이 세우는 계획이 현실적이고 유효하리라 생각하기 어렵다'라고 하는데, 그래도 '잘 모르는 사람인 것 치고 그래도 어느 정도 효용이 있는 계획 세우기'라는 능력을 갖도록 연습하고 노력할 필요가 있는 것 아닐까? 
  
  - '계획을 세우는 게 무슨 의미냐?'라는 마음가짐으로 주석도 안 쓰고 코드부터 쓰다가 한참 지나서 '이 코드는 왜 썼더라?' 하고 스스로 코드 의미를 고심하느라 낭비한 시간이 꽤 있는데, 아무리 잘 모르고 쓴 코드라 하더라도 주석 정도는 남기는 게 좋지 않을까?
  
    - '어차피 지워질 코드인데 주석을 쓰는 건 또 무슨 의미인가?'라는 생각으로 주석을 안 쓰고 그냥 넘어간 코드가 많은데. 효과적인 판단이었을까?
    
      - 이런 고민을 하다 보니, '주석 타이핑하는 게 귀찮아서 주석을 안 쓰는 거면 주석 대신 음성 녹음을 남기면 주석 쓰는 거보다는 더 코멘트를 많이 남기려나?' 하는 생각도 들었다. 사실 Vim 단축키를 이번 개발 하면서 처음 연습 시작한 입장에서는 코드 쓰다 말고 줄 끝에 주석 달고 다시 커서를 방금 전 코드 쓰던 위치로 옮기는 게 너무 불편해서 특히 더 주석 쓰기가 귀찮았던 것도 있다. Vim 단축키가 생산성을 높이는 것 맞을까? 하는 생각이 들기도. 페이지를 한꺼번에 넘기거나 일괄편집 시 분명 좋은 점은 있는데, 페이지 내에 원하는 위치로 커서 옮기는 게 마우스보다 편한지는 아직은 잘 모르겠다. 
